<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI COST AUDIT - KIỂM SOÁT TÀI CHÍNH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #cbd5e1; font-family: 'Segoe UI', monospace; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; }
        .neon-text { text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .cost-negative { color: #f87171; text-shadow: 0 0 5px rgba(248, 113, 113, 0.5); }
        .cost-positive { color: #4ade80; }
        
        /* Scrollbar đẹp */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }

        table tbody tr:hover { background-color: rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body class="min-h-screen p-6">

    <div class="flex justify-between items-center mb-8 border-b border-slate-700 pb-6">
        <div class="flex items-center gap-4">
            <div class="p-3 bg-slate-800 rounded-lg border border-slate-600">
                <i class="fas fa-file-invoice-dollar text-4xl text-yellow-500"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-white tracking-widest neon-text">FINANCIAL AUDIT</h1>
                <p class="text-xs text-slate-400 font-mono">SYSTEM: AI CORPORATION // MODULE: COST TRACKING</p>
            </div>
        </div>
        <div class="text-right">
            <div class="text-green-400 font-bold text-xs uppercase"><i class="fas fa-link"></i> API LINKED</div>
            <div id="clock" class="text-slate-500 font-mono text-xl">--:--:--</div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="glass-panel p-6 border-l-4 border-red-500 relative overflow-hidden">
            <div class="absolute right-4 top-4 text-red-500/20 text-6xl"><i class="fas fa-coins"></i></div>
            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">Tổng chi phí (Total Cost)</h3>
            <p id="total-cost" class="text-4xl font-bold text-white mt-2 cost-negative">$0.000000</p>
            <p class="text-xs text-slate-500 mt-1">Cập nhật theo thời gian thực</p>
        </div>

        <div class="glass-panel p-6 border-l-4 border-blue-500 relative overflow-hidden">
            <div class="absolute right-4 top-4 text-blue-500/20 text-6xl"><i class="fas fa-server"></i></div>
            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">Tổng Token tiêu thụ</h3>
            <p id="total-tokens" class="text-4xl font-bold text-white mt-2">0</p>
            <p class="text-xs text-slate-500 mt-1">Input + Output</p>
        </div>

        <div class="glass-panel p-6 border-l-4 border-purple-500 relative overflow-hidden">
            <div class="absolute right-4 top-4 text-purple-500/20 text-6xl"><i class="fas fa-crown"></i></div>
            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">Giao dịch gần nhất</h3>
            <p id="last-agent" class="text-2xl font-bold text-white mt-2">---</p>
            <p id="last-cost" class="text-xs text-purple-400 mt-1 font-mono">$0.0000</p>
        </div>
    </div>

    <div class="glass-panel p-6 h-[600px] flex flex-col">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white"><i class="fas fa-list-alt text-slate-400 mr-2"></i> NHẬT KÝ GIAO DỊCH CHI TIẾT (AUDIT LOG)</h2>
            <div class="flex gap-2">
                <span class="px-3 py-1 bg-slate-800 rounded text-xs text-slate-400 border border-slate-700">
                    <i class="fas fa-circle text-green-500 text-[8px] mr-1"></i> Live Sync
                </span>
            </div>
        </div>

        <div class="overflow-auto custom-scroll flex-1 rounded-lg border border-slate-700">
            <table class="w-full text-left text-sm text-slate-400">
                <thead class="bg-slate-800 text-xs uppercase text-slate-200 sticky top-0 shadow-lg">
                    <tr>
                        <th class="px-6 py-3 font-bold">Thời gian</th>
                        <th class="px-6 py-3 font-bold">Nhân sự (Agent)</th>
                        <th class="px-6 py-3 font-bold">Model / API</th>
                        <th class="px-6 py-3 text-center">Token (In/Out)</th>
                        <th class="px-6 py-3 text-right font-bold text-yellow-500">Chi phí ($)</th>
                        <th class="px-6 py-3">Nội dung xử lý</th>
                    </tr>
                </thead>
                <tbody id="audit-table-body" class="divide-y divide-slate-700 bg-slate-900/50">
                    <tr>
                        <td colspan="6" class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                            <p class="mt-2 text-xs">Đang kết nối đến Kế toán trưởng (API Server)...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- CẤU HÌNH ---
        // Nếu chạy trên Cloud, thay localhost bằng link Render của ngài
        // Ví dụ: const API_URL = "https://ai-corp.onrender.com";
        const API_URL = ""; // Để trống nếu chạy cùng domain (hoặc điền localhost:8000 nếu chạy local)

        async function fetchAuditLogs() {
            try {
                // Gọi API từ api_server.py (/api/costs)
                const res = await fetch(`${API_URL}/api/costs`);
                if (!res.ok) throw new Error("Mất kết nối API");
                
                const data = await res.json();
                renderTable(data);
                calculateStats(data);

            } catch (e) {
                console.error("Lỗi Audit:", e);
                document.getElementById('audit-table-body').innerHTML = `
                    <tr><td colspan="6" class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-triangle mb-2"></i><br>
                        Không thể tải dữ liệu tài chính.<br>
                        <span class="text-xs text-slate-500">Hãy kiểm tra api_server.py đã chạy chưa?</span>
                    </td></tr>`;
            }
        }

        function calculateStats(data) {
            let totalCost = 0;
            let totalTokens = 0;

            if (data.length > 0) {
                // Tính tổng
                totalCost = data.reduce((sum, item) => sum + (item.cost_usd || 0), 0);
                totalTokens = data.reduce((sum, item) => sum + (item.input_tokens || 0) + (item.output_tokens || 0), 0);
                
                // Agent gần nhất
                const lastItem = data[0];
                document.getElementById('last-agent').innerText = lastItem.agent;
                document.getElementById('last-cost').innerText = `-$${lastItem.cost_usd.toFixed(6)}`;
            }

            // Hiển thị (Format tiền tệ chuẩn)
            document.getElementById('total-cost').innerText = `$${totalCost.toFixed(6)}`;
            document.getElementById('total-tokens').innerText = totalTokens.toLocaleString('en-US');
        }

        function renderTable(data) {
            const tbody = document.getElementById('audit-table-body');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Chưa có giao dịch nào.</td></tr>';
                return;
            }

            const html = data.map(item => {
                // Format màu sắc cho Model để dễ phân biệt
                let modelColor = "text-slate-300";
                if (item.model_used.includes("gpt-4")) modelColor = "text-green-400"; // Đắt
                if (item.model_used.includes("deepseek")) modelColor = "text-blue-400"; // Rẻ
                if (item.model_used.includes("claude")) modelColor = "text-purple-400"; // Sáng tạo

                return `
                <tr class="transition duration-150">
                    <td class="px-6 py-3 font-mono text-xs text-slate-500">${item.timestamp.split(' ')[1]}</td>
                    <td class="px-6 py-3 font-bold text-white">${item.agent}</td>
                    <td class="px-6 py-3 font-mono text-xs ${modelColor}">
                        <i class="fas fa-microchip mr-1"></i> ${item.model_used}
                    </td>
                    <td class="px-6 py-3 text-center text-xs">
                        <span class="text-slate-400" title="Input">${item.input_tokens}</span> / 
                        <span class="text-white" title="Output">${item.output_tokens}</span>
                    </td>
                    <td class="px-6 py-3 text-right font-mono font-bold text-red-400">
                        $${item.cost_usd.toFixed(6)}
                    </td>
                    <td class="px-6 py-3 text-xs text-slate-400 italic truncate max-w-xs" title="${item.knowledge_gained}">
                        ${item.knowledge_gained || "N/A"}
                    </td>
                </tr>
                `;
            }).join('');

            tbody.innerHTML = html;
        }

        // Đồng hồ
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }, 1000);

        // Chạy ngay khi mở và lặp lại mỗi 5s
        fetchAuditLogs();
        setInterval(fetchAuditLogs, 5000);

    </script>
</body>
</html>
