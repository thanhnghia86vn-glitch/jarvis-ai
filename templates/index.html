<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S - AI MONITORING SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0b1121; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .scroll-hide::-webkit-scrollbar { display: none; }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="h-screen overflow-hidden p-4 flex flex-col gap-4">

    <div class="flex justify-between items-center px-4 py-2 bg-slate-800 rounded-lg border border-slate-700 shadow-lg">
        <div class="flex items-center gap-3">
            <div class="h-3 w-3 bg-green-500 rounded-full animate-pulse"></div>
            <h1 class="text-xl font-bold tracking-widest text-cyan-400">J.A.R.V.I.S <span class="text-white text-sm opacity-50">OPERATIONS CENTER</span></h1>
        </div>
        <div class="text-xs text-slate-400 font-mono" id="clock">Connecting...</div>
    </div>

    <div class="flex flex-1 gap-4 overflow-hidden">
        
        <div class="w-1/3 glass-panel rounded-xl p-4 flex flex-col">
            <h2 class="text-sm font-bold text-yellow-500 uppercase mb-4 border-b border-slate-700 pb-2">
                <i class="fas fa-users-cog"></i> Đội Ngũ Nhân Sự (Level)
            </h2>
            <div id="agent-list" class="flex-1 overflow-y-auto space-y-3 scroll-hide pr-2">
                <div class="text-center text-slate-500 mt-10">Đang tải hồ sơ nhân sự...</div>
            </div>
        </div>

        <div class="w-2/3 glass-panel rounded-xl p-4 flex flex-col">
            <h2 class="text-sm font-bold text-cyan-500 uppercase mb-4 border-b border-slate-700 pb-2 flex justify-between">
                <span><i class="fas fa-history"></i> Nhật Ký Hoạt Động Real-time</span>
                <span id="total-cost" class="text-red-400 text-xs">Cost: $0.00</span>
            </h2>
            <div id="work-logs" class="flex-1 overflow-y-auto space-y-4 scroll-hide pr-2">
                <div class="text-center text-slate-500 mt-10">Đang chờ dữ liệu từ vệ tinh...</div>
            </div>
        </div>
    </div>

    <script>
        // 1. Cập nhật đồng hồ
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleString('vi-VN');
        }, 1000);

        // 2. Hàm Load Nhân Sự (Level)
        async function loadAgents() {
            try {
                // QUAN TRỌNG: Dùng đường dẫn tương đối để chạy được cả trên Local lẫn Cloud
                const res = await fetch('/api/agents'); 
                const agents = await res.json();
                
                const container = document.getElementById('agent-list');
                container.innerHTML = agents.map(agent => {
                    // Tính phần trăm thanh kinh nghiệm (Ví dụ 1 cấp = 100XP)
                    const progress = (agent.xp % 100); 
                    const level = Math.floor(agent.xp / 100) + 1;
                    
                    // Màu sắc theo vai trò
                    let roleColor = "border-l-4 border-slate-500";
                    if(agent.role_tag.includes("CODER")) roleColor = "border-l-4 border-green-500";
                    if(agent.role_tag.includes("RESEARCHER")) roleColor = "border-l-4 border-blue-500";
                    if(agent.role_tag.includes("ORCHESTRATOR")) roleColor = "border-l-4 border-purple-500";

                    return `
                    <div class="bg-slate-800/50 p-3 rounded hover:bg-slate-800 transition ${roleColor}">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-sm text-slate-200">${agent.role_tag}</span>
                            <span class="bg-yellow-600/20 text-yellow-500 text-xs px-2 py-0.5 rounded font-mono">LV.${level}</span>
                        </div>
                        <div class="text-xs text-slate-400 mb-2 truncate italic">${agent.current_topic || 'Đang nghỉ ngơi'}</div>
                        
                        <div class="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden">
                            <div class="bg-gradient-to-r from-cyan-500 to-blue-500 h-full" style="width: ${progress}%"></div>
                        </div>
                        <div class="flex justify-between text-[10px] text-slate-500 mt-1">
                            <span>${agent.xp} XP</span>
                            <span>Next: ${(level * 100)}</span>
                        </div>
                    </div>
                    `;
                }).join('');
            } catch (e) { console.error("Lỗi tải Agent:", e); }
        }

        // 3. Hàm Load Nhật Ký (Work Logs) - QUAN TRỌNG NHẤT
        async function loadLogs() {
            try {
                const res = await fetch('/api/costs'); // Gọi vào API Sổ cái mới
                const logs = await res.json();
                
                const container = document.getElementById('work-logs');
                let totalCost = 0;

                if (logs.length === 0) {
                    container.innerHTML = '<div class="text-center text-slate-500 italic">Chưa có hoạt động nào được ghi lại.</div>';
                    return;
                }

                container.innerHTML = logs.map(log => {
                    totalCost += (log.cost_usd || 0);
                    
                    // Icon theo tool
                    let icon = '<i class="fas fa-robot"></i>';
                    if(log.tool && log.tool.toLowerCase().includes('gpt')) icon = '<i class="fas fa-brain text-green-400"></i>';
                    if(log.tool && log.tool.toLowerCase().includes('perplexity')) icon = '<i class="fas fa-globe text-blue-400"></i>';
                    if(log.tool && log.tool.toLowerCase().includes('deepseek')) icon = '<i class="fas fa-code text-indigo-400"></i>';

                    return `
                    <div class="flex gap-4 p-3 bg-slate-800/40 rounded border border-slate-700/50 hover:border-slate-600 transition">
                        <div class="flex-shrink-0 mt-1 text-lg opacity-80">${icon}</div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <span class="text-sm font-bold text-cyan-300">${log.agent}</span>
                                <span class="text-xs text-slate-500 font-mono">${log.timestamp}</span>
                            </div>
                            <div class="text-xs text-white mt-1 font-medium break-words">${log.task}</div>
                            <div class="text-xs text-slate-400 mt-1 bg-slate-900/50 p-2 rounded italic border-l-2 border-slate-600">
                                "${log.result ? log.result.substring(0, 200) + '...' : 'Đã hoàn thành'}"
                            </div>
                            <div class="mt-2 flex justify-between items-center">
                                <span class="text-[10px] bg-slate-700 px-2 py-0.5 rounded text-slate-300">${log.tool || 'Unknown Tool'}</span>
                                <span class="text-xs font-mono text-red-400 font-bold">-$${(log.cost_usd || 0).toFixed(6)}</span>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

                // Cập nhật tổng tiền
                document.getElementById('total-cost').innerText = `Total Cost: $${totalCost.toFixed(4)}`;

            } catch (e) { console.error("Lỗi tải Logs:", e); }
        }

        // Tự động làm mới mỗi 3 giây
        loadAgents();
        loadLogs();
        setInterval(() => {
            loadAgents();
            loadLogs();
        }, 3000);
    </script>
</body>
</html>
